// ==UserScript==
// @name         New Userscript
// @namespace    http://tampermonkey.net/
// @version      0.1
// @description  try to take over the world!
// @author       You
// @match        https://chrome.google.com/webstore/category/extensions
// @grant        none
// ==/UserScript==

var localURL='http://wwwlab.iit.his.se/b15matki/query_results/couchDB_query2.php';
var scrapedData=[];

$(document).ready(function () {
    if(window.location.href.indexOf("start") > -1) {
       collectResponseTime();
       toTextFile();
       nextQuery();
    }
});

function collectResponseTime(){
    // Saving responseStart time
    var responseStartTime = window.performance.timing.responseStart();
    var responseEndTime = window.performance.timing.responseEndTime();
    var responseTotalTime = responseEndTime - responseStartTime;
    if (localStorage.LSresponseTotalTime === null || localStorage.LSresponseTotalTime == "undefined" || localStorage.LSresponseTotalTime == "NaN"){
        localStorage.setItem("LSresponseStartTime", responseTotalTime);
    }else{
        localStorage.LSresponseTotalTime = responseTotalTime;
    }
}

function toTextFile(){
  function ajaxCall(data) {
    try {
      GM_xmlhttpRequest({
        method: 'POST',
        url: localURL,
        data: 'str=' + encodeURIComponent(data),
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        onload: function (response) {
          console.log("Sent " + scrapedData.length + " data post(s).");
        }
      });
   } catch (ex1) {
    console.log(ex1);
    }
  }
  scrapedData.push(localStorage.getItem("LSresponseStartTime"));
  scrapedData.push(localStorage.getItem("LSresponseEndTime"));
  ajaxCall(scrapedData);
}

function nextQuery(){
  window.location.replace("http://localhost:5984/dbo/_design/testqueries/_view/query2?startkey=%22"+ year + "-01-01T00:00:00Z%22&endkey=%22" + year + "-12-31T00:00:00Z%22");
}

